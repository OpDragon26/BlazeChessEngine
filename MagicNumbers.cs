namespace Blaze;

public static class MagicNumbers
{
    // generate a magic number with a push of at least 48
    // reused code from my previous attempt
    public static (ulong magicNumber, int push, int highest) GenerateMagicNumber(ulong[] combinations)
    {
        ulong magicNumber;
        int push = 0;

        ulong[] results = new ulong[combinations.Length];

        while (true) // keep generating magic numbers until one is found
        {
            // generate random ulong
            ulong candidateNumber = RandomUlong();

            // multiply every combination with the magic number and push them right by 48, only leaving the leftmost 16 bits
            for (int i = 0; i < combinations.Length; i++)
            {
                results[i] = (combinations[i] * candidateNumber) >> 48;
            }

            // if the result array contains duplicates, the number isn't magic, so don't bother checking it for further pushes
            if (!results.GroupBy(x => x).Any(g => g.Count() > 1))
            {
                ulong[] temp = (ulong[])results.Clone();

                for (int i = 0; i < 16; i++)
                {
                    // push further right by a certain amount, and check for duplicates again
                    for (int j = 0; j < temp.Length; j++)
                    {
                        temp[j] >>= 1;
                    }

                    // if there are no duplicates in temp
                    if (!temp.GroupBy(x => x).Any(g => g.Count() > 1))
                    {
                        if (i == 0)
                            continue;
                        for (int j = 0; j < results.Length; j++)
                        {
                            results[j] >>= 1;
                        }

                        push++;
                    }
                    else break;

                }

                magicNumber = candidateNumber;
                break;
            }
        }

        return (magicNumber, push + 48, (int)results.Max());
    }

    public static (ulong magicNumber, int push, int highest)[,] Presets(string type)
    {
        return type == "rook" ? RookNumbers : BishopNumbers;
    }

    public static (ulong magicNumber, int push, int highest) GenerateRepeat(ulong[] combinations, int iterations)
    {
        (ulong magicNumber, int push, int highest) magicNumber = (0, 0, 0);
        
        for (int i = 0; i < iterations; i++)
        {
            (ulong magicNumber, int push, int highest) New = GenerateMagicNumber(combinations);
            if (New.push > magicNumber.push || (New.push == magicNumber.push && New.highest < magicNumber.highest))
                magicNumber = New;
        }
        
        return magicNumber;
    }
    
    private static Random RandGen = new();
    
    private static ulong RandomUlong()
    {
        while (true)
        {
            var buffer = new byte[sizeof(ulong)];
            RandGen.NextBytes(buffer);
            return BitConverter.ToUInt64(buffer, 0);
        }
    }
    
    public static readonly (ulong magicNumber, int push, int highest)[,] RookNumbers =
    {
        {
            (9923146022150792333, 47, 131063), (7668639886525986227, 47, 131063), (3629133785401589564, 47, 131068),
            (8706199993787762013, 47, 131067), (4396951879642956839, 47, 131069), (7885189970349236347, 47, 131069),
            (8990451101724604215, 47, 131061), (16059615410457403175, 47, 131056)
        },
        {
            (10712629561810192067, 47, 131068), (14843800520682277201, 47, 131056), (6285520896410588276, 47, 131055),
            (8270101362211238580, 47, 131067), (8229251433712028980, 47, 131069), (5726635721214408384, 47, 131064),
            (7471020051712059711, 47, 131060), (17312941723611444032, 47, 131057)
        },
        {
            (10715252403639884213, 47, 131062), (11409318459344639724, 47, 131068), (2222750398276542267, 47, 131062),
            (7753106238748319563, 47, 131056), (6691691767285863855, 47, 131051), (7877962418500077873, 47, 131067),
            (16993505339122534095, 47, 131067), (4967773378019534508, 47, 131070)
        },
        {
            (11963741368578664693, 47, 131066), (13474550921401300912, 47, 131050), (17340298881836925584, 47, 131064),
            (5411817082414614704, 47, 131053), (8794041926648487619, 47, 131060), (16067264871037795984, 47, 131070),
            (13910088726049108097, 47, 131070), (17506012352560819798, 47, 131061)
        },
        {
            (10864742200142962995, 47, 131063), (12608786547983708161, 47, 131068), (4683822216344260380, 47, 131070),
            (14021165370022003016, 47, 131061), (12410192527782123140, 47, 131070), (7777158592475981146, 47, 131063),
            (7346486222795146463, 47, 131060), (17589453255629190735, 47, 131068)
        },
        {
            (11590144183714373861, 47, 131067), (3521610362190403860, 47, 131060), (10491928793291436471, 47, 131070),
            (4408591932620834412, 47, 131070), (13950220737264665292, 47, 131067), (13098831028647604330, 47, 131064),
            (8831035641484358884, 47, 131058), (10233972736420509612, 47, 131066)
        },
        {
            (3716118917611328159, 47, 131068), (4343630920230470798, 47, 131059), (8293045590004304366, 47, 131070),
            (13644446753367196113, 47, 131055), (351468507416230794, 47, 131070), (13133405702460555318, 47, 131050),
            (9463629074782913314, 47, 131070), (16725758379878316038, 47, 131054)
        },
        {
            (13163919743207779162, 47, 131061), (2801036098447367307, 47, 131070), (544047300546714195, 47, 131058),
            (491686857891303791, 47, 131056), (6433024462075745127, 47, 131065), (1779621975361617255, 47, 131070),
            (12515787739068253761, 47, 131068), (11308302871681451565, 47, 131070)
        }
    };

    public static readonly (ulong magicNumber, int push, int highest)[,] BishopNumbers =
    {
        {
            (10984437588327355704, 51, 8188), (7006058535829348525, 52, 4044), (14906122406994150172, 49, 32619),
            (2066184340015723333, 51, 8150), (1035297900335743484, 52, 4091), (16607782446796926046, 51, 8156),
            (1247444761181602811, 50, 16171), (15870182710494725, 52, 4082)
        },
        {
            (4603830292560296292, 49, 32693), (15855686154953055350, 49, 32707), (7251151001245687602, 47, 130314),
            (16114471141749563029, 51, 8176), (11401233933306946887, 47, 131070), (7195318184353575418, 50, 16367),
            (1649467647888140695, 48, 65305), (11124515084308147271, 51, 8177)
        },
        {
            (11070954177618850525, 53, 2039), (12428895035525312174, 48, 65447), (3141906513735950133, 47, 131021),
            (1970064370294220711, 47, 131024), (2348266627463219689, 47, 130967), (9653558686444912649, 47, 131026),
            (3182850852236480546, 48, 65428), (14615239119142771435, 49, 32443)
        },
        {
            (10973662793716665623, 53, 2030), (9641991183283297038, 48, 65287), (6334974661080060926, 47, 131048),
            (13260876134096857530, 47, 131054), (9398778627118995277, 47, 131053),
            (12206312023251063905, 47, 131070),
            (2084885181953242666, 47, 129879), (16814179508889275684, 52, 4093)
        },
        {
            (16484429464892923043, 52, 4076), (13829589210862379486, 49, 32760), (2596932861749656247, 47, 131040),
            (6043126200206940745, 47, 131031), (12535698615780334274, 47, 131055),
            (15886806933826500261, 47, 130966),
            (1092213874886853380, 50, 16356), (16477038996506879131, 49, 32754)
        },
        {
            (10150045531924313354, 51, 8106), (17054948454648592514, 48, 65528), (17345459729335561269, 47, 130834),
            (13621686841573233274, 47, 131070), (18160237639046435887, 47, 130946),
            (14602156085682375156, 47, 130968),
            (12104214529036088946, 49, 32764), (8861481076252219696, 52, 4091)
        },
        {
            (11410533049506724456, 51, 8046), (8297625402410663567, 48, 65467), (2373818184025873052, 50, 16343),
            (15252246013694177531, 47, 130730), (8797671975670280739, 50, 16358), (2976335728957827031, 47, 130861),
            (18145425317785678925, 49, 32446), (9579073613274333698, 49, 32682)
        },
        {
            (11809129073957181761, 48, 65534), (15444082618789063762, 53, 2034), (17793945967432013766, 52, 4090),
            (13606051810055179660, 51, 8017), (4523306322104149711, 50, 16381), (12569790028625216797, 50, 16350),
            (15377014312014850010, 51, 8169), (16665806180439125489, 50, 16326)
        }
    };

    public static readonly (ulong magicNumber, int push, int highest)[,] RookCaptureNumbers =
    {
        {
            (14604456967665027503, 56, 255), (15030855612444089828, 54, 981), (6688047831116666665, 53, 2007),
            (13484829291533379419, 53, 2027), (17083092214135314798, 53, 2011), (5138923895903764827, 53, 1922),
            (2547076760937996999, 54, 980), (10629062473752459225, 55, 484),
        },
        {
            (9566304857179572409, 54, 996), (16152341572430674507, 52, 4031), (9916443788163847104, 52, 4091),
            (13374380108794745528, 51, 8127), (7843816915093650940, 51, 8103), (14544432741627316856, 51, 8078),
            (15732595319566714928, 52, 3985), (7274982144384011016, 54, 1004),
        },
        {
            (12641081145366623371, 54, 1023), (48605642636088670, 52, 4019), (11138840179260039938, 51, 8150),
            (16459822455724996923, 51, 8097), (2938885884629942903, 51, 8175), (7701437090464592870, 51, 8015),
            (12772819960757244405, 52, 4069), (12874627079843572519, 53, 2005),
        },
        {
            (9563971048091704337, 53, 1991), (4491987350889830905, 52, 4060), (11832397244458700043, 51, 8181),
            (9525462817512934386, 51, 8166), (2172757164174072828, 51, 8158), (11476436441325750713, 51, 8150),
            (1057658445972773057, 52, 4043), (4499502565864162972, 53, 2022),
        },
        {
            (9099294879764643511, 53, 1965), (11594743994153637065, 52, 4033), (12167379491498309759, 51, 8165),
            (11417493042976916266, 51, 8172), (3835989269279448590, 50, 16270), (15937921179970878103, 51, 8160),
            (12787844087692895757, 52, 4092), (15579640977171019974, 53, 2005),
        },
        {
            (6707879716083770941, 54, 1011), (2833772578567048722, 52, 4048), (16769154065588861822, 51, 8135),
            (12193546611975456921, 51, 8174), (13315025295095227309, 51, 8138), (4203829373763519134, 51, 8075),
            (10265243177018767893, 52, 4082), (6220317082795579002, 53, 1999),
        },
        {
            (10565862648602885013, 55, 510), (7168333251450808470, 53, 2036), (12132319325642037495, 52, 3958),
            (3662104437632056825, 51, 8099), (17784356235210192774, 51, 8072), (411820530693705535, 51, 7998),
            (15074416277371023055, 52, 4060), (16575104471015861381, 54, 962),
        },
        {
            (10602242798878830002, 56, 249), (4194632750312316295, 55, 510), (17367427758005052093, 53, 1994),
            (1674974279219214345, 53, 2025), (7143744494194807823, 53, 2020), (16723877777722561429, 53, 2020),
            (9922569140665507437, 54, 1001), (13233806743718493725, 56, 254),
        },
    };

    public static readonly (ulong magicNumber, int push, int highest)[,] BishopCaptureNumbers =
    {
        {
            (9010333806965627226, 60, 12), (5811303244256242621, 59, 29), (12058155319510274934, 58, 58),
            (3270513639895394931, 58, 58), (9914061933516417069, 58, 57), (3468652931739223373, 58, 59),
            (4940146462343522189, 59, 30), (60185820055621870, 60, 12),
        },
        {
            (16730356667005787888, 59, 30), (15251008292128528736, 56, 253), (9847215698271422169, 55, 494),
            (14507762940054118443, 55, 492), (9836004619008120422, 55, 495), (5753269651213440499, 55, 493),
            (841617448073117735, 55, 486), (14672718207212899165, 59, 26),
        },
        {
            (3930659230268668201, 58, 58), (422409696708773304, 55, 491), (1701612587755361082, 53, 2023),
            (11084771356828508972, 52, 4021), (7943083258768691613, 52, 4021), (246838184775233615, 52, 3991),
            (15918730708686889251, 55, 501), (13254301822135402785, 58, 59),
        },
        {
            (5551530884397660518, 58, 59), (2904163013088279043, 55, 493), (5316583823019121053, 52, 4047),
            (2099570295207240706, 50, 16177), (10881422048241230787, 50, 16134), (3702398429123520680, 52, 4016),
            (9291173530400856704, 54, 993), (14293513818427751334, 58, 58),
        },
        {
            (12446836850553310619, 58, 62), (1324876417714696939, 55, 508), (7303199974608006850, 52, 3965),
            (1137747741614215187, 51, 8158), (7445835233037188314, 51, 8165), (3060445070281129583, 52, 4043),
            (15752047691729508674, 55, 510), (8203951470433400076, 58, 61),
        },
        {
            (9491091462610758234, 58, 60), (5051904581661437386, 56, 254), (8405621750973243769, 53, 2020),
            (31189932326087379, 52, 4042), (10013820544213564781, 52, 4049), (7376924805545288770, 53, 2022),
            (2429715527183273329, 55, 502), (12894257944229531122, 58, 54),
        },
        {
            (5758070153187885914, 59, 29), (12978597118238358829, 56, 249), (1844508211362032708, 55, 498),
            (2941780388250078236, 54, 974), (14419494117493763239, 54, 992), (2678850258537692104, 55, 504),
            (2019123620504260158, 55, 482), (12848244373151914739, 59, 30),
        },
        {
            (13484051423106065556, 60, 14), (1091459530227093865, 59, 28), (14832483110317302309, 58, 55),
            (13422437621663051247, 58, 63), (3696128101689265044, 58, 61), (5925957648693126804, 58, 54),
            (12410256091080296116, 58, 51), (6747664203482260689, 60, 12),
        },
    };

    public static readonly (ulong magicNumber, int push, int highest)[,] KnightNumbers =
    {
        {
            (4213676592776040603, 61, 6), (808408947955507185, 60, 14), (16963565108934586562, 59, 30),
            (573115046082495782, 59, 30), (12156813312854239751, 59, 30), (14074099221382392032, 59, 30),
            (2888185195808407391, 60, 14), (10475772087203011374, 61, 6),
        },
        {
            (2469661812558223614, 60, 14), (8239392681613658638, 59, 30), (6286539138790868484, 56, 200),
            (15556548148750665240, 56, 246), (7404718928578338643, 56, 236), (6762987143332244783, 56, 248),
            (16730202879017778776, 59, 30), (39230985230081057, 60, 14),
        },
        {
            (6952325437502511, 59, 30), (3920170366468096180, 56, 246), (1271271514612533967, 53, 2019),
            (9602032458780865690, 53, 2031), (4070371430365924078, 53, 2032), (4771335980013109165, 53, 2031),
            (13774237551004564925, 56, 245), (9553278973925469675, 59, 30),
        },
        {
            (15166462884268499094, 59, 30), (6175404168450639348, 56, 243), (8513515329442144280, 54, 1021),
            (7002917578961288694, 53, 2017), (2376946087991284407, 53, 2032), (4534647674833750750, 53, 2021),
            (9954597193904699111, 56, 248), (14590000767461115766, 59, 30),
        },
        {
            (8055173476809312782, 59, 30), (11090869709082870435, 57, 126), (7499630584370057330, 54, 981),
            (3296989605669134658, 53, 2023), (16500173358649078557, 53, 2032), (13344864798714543066, 53, 2021),
            (5463632756021360379, 56, 250), (7054049079284663758, 59, 30),
        },
        {
            (3551619717381884548, 59, 30), (4221346403705405205, 56, 236), (16288262982767754982, 54, 1017),
            (1324099807659685995, 53, 2028), (6930368457193127972, 53, 2028), (1008094912519895388, 53, 2025),
            (16321906157804397369, 56, 242), (6354650574294438347, 59, 30),
        },
        {
            (10558821836590494625, 60, 14), (8793859125239129640, 59, 30), (9755983088764294933, 57, 126),
            (4589120049736448047, 56, 245), (8787661853325006163, 56, 239), (6577023664294630843, 56, 247),
            (4404569093463347202, 59, 30), (14023104255707510421, 60, 14),
        },
        {
            (10676862309737651292, 61, 6), (5616990624400221206, 60, 14), (17791272422881628553, 59, 30),
            (14036046260490357260, 59, 30), (11762140548173728179, 59, 30), (7303994849371872528, 59, 30),
            (4797273506439055731, 60, 14), (5646966869293985530, 61, 6),
        },
    };

    public static readonly (ulong magicNumber, int push, int highest)[,] KingNumbers =
    {
        {
            (2110450308958602198, 60, 14), (2818866612791197913, 58, 62), (6611889612521214269, 58, 62),
            (8479689179966978026, 58, 62), (17584375646680530737, 58, 62), (6359193113664043896, 58, 62),
            (4691573928558046222, 58, 62), (15150388903847750655, 60, 14),
        },
        {
            (5199960015383633938, 58, 62), (10695973319595524737, 54, 922), (15120420590223107333, 54, 1016),
            (522754086792477651, 54, 1005), (1679660322492961614, 54, 998), (7214126561997178742, 54, 1011),
            (2730276924530782662, 54, 1016), (9372209917432506957, 58, 63),
        },
        {
            (3707161399472353307, 58, 62), (14423079475113148466, 54, 1005), (4000178572439339865, 54, 987),
            (5235041708923701273, 54, 1015), (2772988018294064943, 54, 1015), (362542075316868662, 54, 1006),
            (20275744369891284, 54, 1008), (13335213818908481732, 58, 63),
        },
        {
            (9540502278189355288, 58, 62), (10293365349487481128, 54, 994), (12092437779965822781, 54, 1011),
            (4816693718315558568, 54, 1012), (1631306483734011274, 54, 1011), (15101531479219809933, 54, 1016),
            (13947956781744457454, 54, 1014), (12110484169313237798, 58, 63),
        },
        {
            (2059812440713420937, 57, 66), (12515670379503505247, 54, 992), (7112488615688482656, 54, 997),
            (9582803241734009963, 54, 1012), (5620218014933533422, 54, 1018), (5510312493059312836, 54, 1018),
            (2581094718123234099, 54, 1011), (14286566650061174351, 58, 62),
        },
        {
            (13608792375486610502, 58, 62), (5623721625481914382, 54, 983), (7300305881875226841, 54, 1015),
            (6403466111320873017, 54, 977), (10195674301538108573, 54, 1015), (1996153097014676447, 54, 1016),
            (15997355665052632358, 54, 1003), (12114964898291359634, 58, 62),
        },
        {
            (11234684274728877603, 58, 62), (6644879040106635283, 55, 511), (4937989032574816606, 54, 1018),
            (13806922824112196561, 54, 1013), (16706483719831657337, 54, 1006), (7141740152243585516, 54, 1017),
            (1517492648617939737, 54, 1015), (10835943917450760176, 58, 63),
        },
        {
            (14624564417431463322, 60, 14), (12669931155572581253, 58, 62), (10687320650953123587, 58, 62),
            (13011260460470174247, 58, 63), (747361160914997856, 58, 63), (10658544373956545143, 58, 62),
            (8864885346442875003, 58, 63), (9966332368594430056, 60, 14),
        },
    };

    public static readonly (ulong magicNumber, int push, int highest)[,] WhitePawnNumbers =
    {
        {
            (0, 0, 0), (10626186092562371579, 59, 30), (16861957131806080575, 60, 14), (15988390848716213835, 60, 14),
            (12241279915589227513, 60, 14), (17239890792139424729, 60, 14), (7132912315175543523, 60, 14), (0, 0, 0),
        },
        {
            (0, 0, 0), (16302273445212758826, 59, 30), (14793812243017050953, 60, 14), (11427860831515337918, 60, 14),
            (12792580463503365938, 60, 14), (10962147440300329567, 60, 14), (16271803352827755188, 60, 14), (0, 0, 0),
        },
        {
            (0, 0, 0), (15682171787512134433, 59, 30), (14405545794170355127, 60, 14), (12248923819821317741, 60, 14),
            (14144241043356245964, 60, 14), (10588533472035921983, 60, 14), (12728875053730911026, 60, 14), (0, 0, 0),
        },
        {
            (0, 0, 0), (18055323862528698437, 59, 30), (1765583093819601450, 60, 14), (11836830467044561358, 60, 14),
            (5178631731013821827, 60, 14), (15571344671168097983, 60, 14), (12829782612412527252, 60, 14), (0, 0, 0),
        },
        {
            (0, 0, 0), (10660155719229385422, 59, 30), (4900249899799490527, 60, 14), (3779002103278560135, 60, 14),
            (2104434520811270367, 60, 14), (15176136258599245609, 60, 14), (1804268870727970716, 60, 14), (0, 0, 0),
        },
        {
            (0, 0, 0), (15288771155037454962, 59, 30), (18118909702821920429, 60, 14), (13626162966853432335, 60, 14),
            (8719331737983687288, 60, 14), (11897950606366251171, 60, 14), (8506764411192007374, 60, 14), (0, 0, 0),
        },
        {
            (0, 0, 0), (1387599962212895579, 59, 30), (1020588608526088196, 60, 14), (1897043955015253551, 60, 14),
            (8163228575059704243, 60, 14), (10742497886646145148, 60, 14), (5838584086238233961, 60, 14), (0, 0, 0),
        },
        {
            (0, 0, 0), (5278924173090033761, 59, 30), (4462709938410050238, 60, 14), (17277373967549726619, 60, 14),
            (2253804795689972321, 60, 14), (2768447957014149888, 60, 14), (3279351894293613908, 60, 14), (0, 0, 0),
        },
    };

    public static readonly (ulong magicNumber, int push, int highest)[,] BlackPawnNumbers =
    {
        {
            (0, 0, 0), (11334597112378169922, 60, 14), (12703238830571373513, 60, 14), (391895858272042526, 60, 14),
            (2870264896256108865, 60, 14), (10238938984047805867, 60, 14), (5875159246769917757, 59, 30), (0, 0, 0),
        },
        {
            (0, 0, 0), (7958920766299466848, 60, 14), (17705195409933181951, 60, 14), (7591614432784978462, 60, 14),
            (10836747289965106722, 60, 14), (11128737050424648039, 60, 14), (1495376962170321109, 59, 30), (0, 0, 0),
        },
        {
            (0, 0, 0), (2214767136627056882, 60, 14), (1474399315848450247, 60, 14), (17082433803264245364, 60, 14),
            (2621802692569258365, 60, 14), (13046290206418367069, 60, 14), (15501231613373347279, 59, 30), (0, 0, 0),
        },
        {
            (0, 0, 0), (1131758202093690616, 60, 14), (16017596958648006890, 60, 14), (6595879212077814274, 60, 14),
            (12319204020814151243, 60, 14), (962400158063946875, 60, 14), (17900555145285967355, 59, 30), (0, 0, 0),
        },
        {
            (0, 0, 0), (5419208531338525852, 60, 14), (15571057976862120208, 60, 14), (8805355011638561258, 60, 14),
            (7936193842655301133, 60, 14), (4178607716008925718, 60, 14), (5208012803504017186, 59, 30), (0, 0, 0),
        },
        {
            (0, 0, 0), (17737920725203805378, 60, 14), (5866358137808789059, 60, 14), (1751997690585695517, 60, 14),
            (9664543339413553688, 60, 14), (8146591893512107324, 60, 14), (13826391806145240768, 59, 30), (0, 0, 0),
        },
        {
            (0, 0, 0), (15543712245427163097, 60, 14), (9495312535661563463, 60, 14), (3896877347228418088, 60, 14),
            (14250901479895480085, 60, 14), (5643876692437340067, 60, 14), (7808431449442134299, 59, 30), (0, 0, 0),
        },
        {
            (0, 0, 0), (17114559466376493631, 60, 14), (7496378230920950918, 60, 14), (3645880812521947146, 60, 14),
            (6482970007046874151, 60, 14), (8045833182289111976, 60, 14), (13366951458946607137, 59, 30), (0, 0, 0),
        },
    };
}